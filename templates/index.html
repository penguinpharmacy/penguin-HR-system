<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>員工特休總覽｜後台</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  <style>
    :root{
      --brand:#2563eb; --brand-weak:#eff6ff;
      --bg:#f6f8fb; --card:#ffffff; --line:#e5e7eb;
      --text:#0f172a; --muted:#64748b;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --pill:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,"PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .text-2xl{font-size:1.6rem;font-weight:800}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .right{text-align:right}
    .topbar{background:linear-gradient(180deg, rgba(37,99,235,.08), rgba(37,99,235,0) 65%)}
    .nav{display:flex;align-items:center;gap:12px;padding:14px 0;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:32px;width:auto;display:block}
    .brand .name{font-weight:800;letter-spacing:.5px}
    .nav-links{display:flex;align-items:center;gap:8px;margin-left:18px;flex-wrap:wrap}
    .btn{display:inline-block;border:1px solid var(--line);background:#fff;border-radius:10px;padding:.45rem .7rem}
    .btn:hover{background:#f9fafb}
    .btn-primary{color:var(--brand);border-color:var(--brand);background:var(--brand-weak)}
    .spacer{flex:1}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:8px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .kpi-title{font-size:.85rem;color:var(--muted)}
    .kpi-value{font-size:1.35rem;font-weight:800}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:14px 0}
    .input{border:1px solid var(--line);border-radius:10px;padding:.48rem .6rem;min-width:220px;background:#fff}
    .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .scroll-x{overflow-x:auto}
    table{border-collapse:collapse;min-width:1100px;width:100%}
    thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid var(--line);
      text-align:left;padding:.6rem .75rem;white-space:nowrap;font-weight:700;letter-spacing:.2px}
    tbody td{border-top:1px solid var(--line);padding:.55rem .75rem;vertical-align:top}
    tbody tr:hover{background:#fcfcfd}
    .row-warn{background:#fffbeb}
    .row-danger{background:#fef2f2}
    .pill{display:inline-block;padding:2px 8px;border-radius:9999px;background:var(--pill);font-size:12px}
    .pill-ok{color:var(--ok)}
    .pill-warn{color:var(--warn);background:#fff7ed}
    .pill-danger{color:var(--danger);background:#fef2f2}
    .note{font-size:.86rem;color:var(--muted)}
    @media (max-width:768px){
      .cards{grid-template-columns:1fr}
      .container{padding:14px}
      .brand .name{display:none}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="nav">
        {# 直接使用後端傳進來的 current_store_id #}
        {% set sid = current_store_id %}
        <a class="brand" href="{{ url_for('index', store_id=sid, all=request.args.get('all')) }}">
          <img
            src="{{ url_for('static', filename='logo.png') }}"
            alt="公司 Logo"
            onerror="this.closest('.brand').querySelector('.name').style.display='inline-block'; this.remove();">
          <div class="name" style="display:none">企業後台</div>
        </a>

        <div class="text-2xl">員工特休總覽</div>

        <!-- 分店下拉（動態） -->
        <select id="storeSelect" class="input" style="max-width:260px;margin-left:12px">
          <option value="" {% if not sid %}selected{% endif %}>全部分店</option>
          {% for s in stores %}
            <option value="{{ s[0] }}" {% if sid == s[0] %}selected{% endif %}>{{ s[1] }}</option>
          {% endfor %}
        </select>

        <div class="nav-links">
          <a class="btn" href="{{ url_for('index', store_id=sid, all=('0' if show_all else '1')) }}">
            {{ '顯示在職員工' if show_all else '顯示所有員工（含離職）' }}
          </a>
          <a class="btn" href="{{ url_for('branch_management') }}">分店管理</a>
          <a class="btn" href="{{ url_for('list_insurance') }}?store_id={{ sid or '' }}">保險負擔</a>
          <a class="btn" href="{{ url_for('add_employee') }}?store_id={{ sid or '' }}">新增員工</a>
          <a class="btn btn-primary" href="{{ url_for('leave_expiring') }}?store_id={{ sid or '' }}">特休即將到期</a>
        </div>

        <span class="spacer"></span>

        <div class="note nowrap">
          目前顯示：{% if show_all %}<b>全部（含離職／停用）</b>{% else %}<b>在職員工</b>{% endif %}・
          共 <b id="rowCount">{{ employees|length }}</b> 人
        </div>
      </div>

      <!-- KPI -->
      <div class="cards">
        <div class="card">
          <div class="kpi-title">特休到期（提醒視窗）</div>
          <div class="kpi-value" id="leave-expiry-count">—</div>
          <div class="note" id="leave-expiry-window"></div>
          <div style="margin-top:6px"><a href="{{ url_for('leave_expiring') }}?store_id={{ sid or '' }}">查看到期名單 →</a></div>
        </div>
        <div class="card">
          <div class="kpi-title">在職人數</div>
          <div class="kpi-value">{{ employees|length }}</div>
          <div class="note">依目前篩選狀態</div>
        </div>
        <div class="card">
          <div class="kpi-title">提示</div>
          <div class="note">紅底列＝特休剩餘 &lt; 8 小時；黃底＝&lt; 24 小時。膠囊顏色為病/事/婚假低餘額提醒。</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- 工具列 -->
    <div class="card toolbar">
      <input id="searchInput" class="input" type="search" placeholder="搜尋 姓名／部門／職等…">
      <button class="btn" id="clearBtn" type="button">清除搜尋</button>
      <button class="btn" id="exportBtn" type="button">匯出目前列表為 CSV</button>
    </div>

    <!-- 表格 -->
    <div class="table-wrap scroll-x">
      <table id="empTable">
        <thead>
          <tr>
            <th>姓名</th>
            <th>部門</th>
            <th>到職日</th>
            <th>離職日</th>
            <th>薪資級距</th>
            <th>職等</th>
            <th class="right">底薪</th>
            <th class="right">職務津貼</th>
            <th>年資</th>
            <th class="right">應特休（小時）</th>
            <th class="right">已用（小時）</th>
            <th class="right">剩餘（小時）</th>
            <th>病假剩餘</th>
            <th>事假剩餘</th>
            <th>婚假剩餘</th>
            <th>留停</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tbodyData">
          {% for e in employees %}
          <tr class="{% if e.remaining < 8 %}row-danger{% elif e.remaining < 24 %}row-warn{% endif %}">
            <td data-col="name">{{ e.name }}</td>
            <td data-col="dept">{{ e.department }}</td>
            <td class="nowrap">{{ e.start_date }}</td>
            <td class="nowrap">{{ e.end_date }}</td>
            <td>
              <a href="{{ url_for('salary_detail', emp_id=e.id) }}?store_id={{ sid or '' }}">{{ e.salary_grade }}</a>
            </td>
            <td data-col="level">{{ e.job_level }}</td>
            <td class="right">{{ e.base_salary }}</td>
            <td class="right">{{ e.position_allowance }}</td>
            <td class="nowrap">{{ e.years }} 年 {{ e.months }} 月</td>
            <td class="right">{{ e.entitled }}</td>
            <td class="right">
              <a href="{{ url_for('leave_history', emp_id=e.id, leave_type='特休') }}?store_id={{ sid or '' }}">{{ e.used }}</a>
            </td>
            <td class="right">
              <a href="{{ url_for('leave_history', emp_id=e.id, leave_type='特休') }}?store_id={{ sid or '' }}">{{ e.remaining }}</a>
            </td>
            <td>
              <a href="{{ url_for('leave_history', emp_id=e.id, leave_type='病假') }}?store_id={{ sid or '' }}">
                {% set v = '%.1f'|format(e.remaining_sick) %}
                <span class="pill {% if e.remaining_sick<=2 %}pill-danger{% elif e.remaining_sick<=5 %}pill-warn{% else %}pill-ok{% endif %}">{{ v }} 天</span>
              </a>
            </td>
            <td>
              <a href="{{ url_for('leave_history', emp_id=e.id, leave_type='事假') }}?store_id={{ sid or '' }}">
                {% set v = '%.1f'|format(e.remaining_personal) %}
                <span class="pill {% if e.remaining_personal<=2 %}pill-danger{% elif e.remaining_personal<=5 %}pill-warn{% else %}pill-ok{% endif %}">{{ v }} 天</span>
              </a>
            </td>
            <td>
              <a href="{{ url_for('leave_history', emp_id=e.id, leave_type='婚假') }}?store_id={{ sid or '' }}">
                {% set v = '%.1f'|format(e.remaining_marriage) %}
                <span class="pill {% if e.remaining_marriage<=2 %}pill-danger{% elif e.remaining_marriage<=5 %}pill-warn{% else %}pill-ok{% endif %}">{{ v }} 天</span>
              </a>
            </td>
            <td>{{ '是' if e.suspend else '否' }}</td>
            <td class="nowrap">
              {% if e.is_active %}
                <a href="{{ url_for('edit_employee', emp_id=e.id) }}?store_id={{ sid or '' }}">編輯</a>
                <a href="{{ url_for('list_insurance') }}?store_id={{ sid or '' }}" class="muted" title="前往保險列表" style="margin-left:8px">保險</a>
                <a href="{{ url_for('delete_employee', emp_id=e.id) }}?store_id={{ sid or '' }}" style="margin-left:8px;color:var(--danger)" onclick="return confirm('確定要封存此員工？');">刪除</a>
              {% else %}
                <span class="muted">已離職</span>
                <a href="{{ url_for('restore_employee', emp_id=e.id) }}?store_id={{ sid or '' }}" style="margin-left:8px">復職</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          {% if not employees %}
          <tr id="noDataRow"><td colspan="17" class="muted" style="text-align:center;padding:16px">尚無資料</td></tr>
          {% endif %}
          <tr id="noMatchRow" style="display:none;"><td colspan="17" class="muted" style="text-align:center;padding:16px">沒有符合搜尋結果</td></tr>
        </tbody>
      </table>
    </div>

    <p class="note" style="margin-top:10px">
      ※ 搜尋與 CSV 匯出僅針對「目前畫面顯示」的資料列（在職或全部）。
    </p>
  </div>

  <script>
    (function() {
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      const input = $('#searchInput');
      const clearBtn = $('#clearBtn');
      const exportBtn = $('#exportBtn');
      const rows = () => $$('#tbodyData > tr').filter(r => r.id !== 'noDataRow' && r.id !== 'noMatchRow');
      const noDataRow = $('#noDataRow');
      const noMatchRow = $('#noMatchRow');
      const rowCountEl = $('#rowCount');

      function norm(s){ return (s||'').toString().trim().toLowerCase(); }
      function visibleRowsCount(){ return rows().filter(r => r.style.display !== 'none').length; }
      function updateCount(){ if (rowCountEl) rowCountEl.textContent = visibleRowsCount(); }

      function applyFilter() {
        const q = norm(input.value);
        let anyVisible = false;
        rows().forEach(tr => {
          const name = norm(tr.querySelector('[data-col="name"]')?.textContent);
          const dept = norm(tr.querySelector('[data-col="dept"]')?.textContent);
          const level = norm(tr.querySelector('[data-col="level"]')?.textContent);
          const match = !q || name.includes(q) || dept.includes(q) || level.includes(q);
          tr.style.display = match ? '' : 'none';
          if (match) anyVisible = true;
        });
        const hasServerData = rows().length > 0;
        if (noDataRow) noDataRow.style.display = hasServerData ? 'none' : '';
        if (noMatchRow) noMatchRow.style.display = (hasServerData && !anyVisible) ? '' : 'none';
        updateCount();
      }

      function clearFilter(){ input.value=''; applyFilter(); input.focus(); }

      function csvEscape(field){ const text=(field??'').toString(); return `"${text.replace(/"/g,'""')}"`; }
      function exportCsv(){
        const table = $('#empTable'); if (!table) return;
        const ths = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
        const lines = []; lines.push(ths.map(csvEscape).join(','));
        rows().forEach(tr => {
          if (tr.style.display === 'none') return;
          const tds = Array.from(tr.querySelectorAll('td'));
          const cells = tds.map(td => td.innerText.replace(/\s+\n\s+/g,' ').trim());
          lines.push(cells.map(csvEscape).join(','));
        });
        const csvContent = '\uFEFF' + lines.join('\n');
        const blob = new Blob([csvContent], { type:'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        const now = new Date(), y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
        a.download = `員工特休總覽_${y}${m}${d}.csv`;
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
      }

      input?.addEventListener('input', applyFilter);
      clearBtn?.addEventListener('click', clearFilter);
      exportBtn?.addEventListener('click', exportCsv);
      applyFilter();

      // 分店切換：更新 URL 的 store_id
      const select = document.getElementById('storeSelect');
      select?.addEventListener('change', () => {
        const params = new URLSearchParams(window.location.search);
        if (select.value) params.set('store_id', select.value); else params.delete('store_id');
        const url = '{{ url_for("index") }}' + (params.toString() ? ('?' + params.toString()) : '');
        window.location.href = url;
      });

      // 到期提醒 KPI（帶上 store_id）
      const params = new URLSearchParams(location.search);
      const sid = params.get('store_id') || '';
      const countEl = document.getElementById('leave-expiry-count');
      const winEl = document.getElementById('leave-expiry-window');
      fetch('{{ url_for("leave_expiring_json") }}' + (sid ? ('?store_id=' + encodeURIComponent(sid)) : ''))
        .then(r => r.json())
        .then(d => {
          countEl.textContent = d.count + ' 人';
          winEl.textContent = `提醒視窗：${d.alert_within_days} 天內`;
        })
        .catch(()=>{ countEl.textContent='讀取失敗'; });
    })();
  </script>
</body>
</html>
